57 Интерфейс ATA. Архитектура, конфигурация. Протоколы обмена. Электрический интерфейс. Регистры устройства ATA. Протокол взаимодействия хоста и устройства. Взаимоотношения между BIOS и схемой физической адресации секторов режимы PIO, DMA и UDMA

Назначение интерфейса ATA – обмен данными с вынесенным на внешнее устройство контроллером: передача и прием данных, подача команд, отслеживание ошибок, доступ к управляющим и статусным регистрам. С электрической точки зрения - упрощенный вариант шины ISA. 
Конфигурация:

Рисунок

Архитектура ATA предусматривает подключение к одному контроллеру (или каналу многоканального контроллера) двух устройств: Device 0 называется Master (ведущее), Device 1 – Slave (ведомое). Оба устройства отображают одинаковый набор регистров на общее адресное пространство, поэтому работать одновременно не могут. Для выборки устройства предусмотрен особый механизм: регистр DH содержит бит DEV, обращение к которому отслеживают оба устройства. Запись значения в регистр DH означает выбор либо устройства Device 0, либо Device 1. До смены бита DEV предполагается, что контроллер работает с одним и тем же устройством. 

Электрический интерфейс. Сигналы имеют уровни TTL (высокий – от 2.4 до 5.5 В, низкий – от -0.5 до 0.8 В). Стандартный разъем для винчестеров имеет 40 контактов, плоский шлейф состоит из 40 проводников. Для режимов UltraDMA/66 и выше требуется шлейф с 80 проводниками с теми же 40-контактными разъ­емами. Питание – через отдельный 4-контрактный разъем от блока питания. Кабель обычно содержит 3 разъема для подключения двух устройств с хост-контроллеру. 
Регистры устройства АТА. Определены два блока 8-битных регистров, выбор которого зависит от сигналов CS0# и CS1#: (1) Блок командных регистров служит для подачи команд и проверки состояния. (2) Блок управляющих регистров служит для задания некоторых важных параметров и безопасного (без сброса) чтения состояния. Доступ к регистрам возможен только при отсутствии занятости (биты BSY=0 и DRQ=0 в регистре состояния), иначе их содержимое недействительно.

Протоколы взаимодействия хоста и устройства: (1). Хост читает регистр состояния устройства, дожидаясь нулевого значения бита BSY. Если присутствуют два устройства, хост обращается к ним "наугад" – состояние будет сообщать последнее выбранное устройство. (2). До­ждавшись освобождения устройства, хост записывает в регистр DH байт, у которого бит DEV указывает на адресуемое устройство. (3). Хост читает основной или альтернативный регистр состояния адресованного устройства, дожидаясь признака готовности (DRDY=1), (4). Хост зано­сит требуемые параметры в блок командных регистров. (5). Хост записывает код команды в регистр команд. (6). Устройство устанавливает бит BSY и переходит к исполнению команды. Дальнейшие действия зависят от протокола передачи данных, заданного командой. (далее для каждого случая очень длинный список, вот эти случаи: Для команд, не требующих передачи данных (ND) - (7. Завершив исполнение команды, устройство сбрасывает бит BSY и устанавливает запрос прерывания (если он не запрещен). К этому моменту в регистрах состояния и ошибок уже имеется информация о Единичное значение бита BSY может промелькнуть между шагами 6 и 7 так быстро, что хост его не зафиксирует, но для фиксации факта выполнения команды или ее части и предназначен запрос прерывания), Для команд, требующих чтения данных в режиме PIO (Р1) (7. Подготовившись к передаче первого блока данных по шине АТА, устройство устанавливает бит DRQ. Если была ошибка, она фиксируется в регистрах состояния и ошибок. Далее устройство сбрасывает бит BSY и устанавливает запрос прерывания (если он не запрещен). 8 Зафиксировав обнуление бита BSY (или по прерыванию), хост считывает регистр состояния, что приводит к сбросу прерывания от устройства. 9 Если хост обнаружил единичное значение бита DRQ, он производит чтение первого блока данных в режиме PIO (адресуясь к регистру данных). Если обнаружена ошибка, считанные данные могут быть недостоверными) , Для команд, требующих записи данных в режиме РЮ (РО и Р) (7 Подготовившись к приему первого блока данных по шине ATА, устройство устанавливает бит DRQ (если нет ошибок) и сбрасывает бит BSY. Если была ошибка, она фиксируется 8 Зафиксировав обнуление бита BSY, хост считывает регистр состояния 9 Если хост обнаружил единичное значение бита DRQ, он производит запись первого блока данных в режиме PIO по адресу в регистре данных)

Взаимодействие: Когда операционная система обращается к BIOS для чтения или записи секторов, она выдает соответствующие команды через программное прерывание INT13h, которое обращается к стандартной подпрограмме BIOS, используемой для доступа к диску. Подфункции прерывания INT13h позволяют выполнять чтение или запись секторов, используя при этом адресацию LBA или CHS. После этого стандартные
программы базовой системы ввода-вывода преобразуют команды BIOS в аппаратные команды АТА, которые передаются через порты шины ввода-вывода на контроллер дисковода. Аппаратные команды АТА также могут использовать адресацию CHS или LBA, несмотря на то что существуют определенные ограничения.


